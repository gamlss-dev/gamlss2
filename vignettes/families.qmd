---
title: "Family Objects"
format: 
  html:
    html-math-method: mathjax
    toc: true
    number-sections: true
bibliography: gamlss2.bib
nocite: |
  @Rigby+Stasinopoulos:2005
vignette: >
  %\VignetteIndexEntry{Family Objects}
  %\VignetteEngine{quarto::html}
  %\VignetteDepends{gamlss2}
  %\VignetteKeywords{distributional regression, family objects}
  %\VignettePackage{gamlss2}
---

```{r preliminaries, echo=FALSE, message=FALSE, results="hide"}
library("gamlss2")
```

All family objects of the `gamlss.dist` package, see @Rigbyetal2019, can be used for modelling in `gamlss2`. However, for users wanting to specify their own (new) distribution model, this document provides a guide
on how to define custom family objects within the `gamlss2` framework.

Family objects in the `gamlss2` package play an essential role in defining the models used for
fitting data to distributions. These objects encapsulate the necessary details about the
distribution and the parameters, such as:

* The names of the parameters.
* The link functions that map the parameters to the predictor.
* Functions for the density, log-likelihood, and their derivatives.

This document provides an overview of how to construct and use family objects within `gamlss2`.
By the end, you should have a good understanding of how to implement a custom family for
use in statistical models.

## Defining Family Objects

A family object in `gamlss2` is a list that must meet the following minimum criteria:

* **Family Name**: The object must contain the family name as a character string.
* **Parameters**: The object must list the parameters of the distribution (e.g., `"mu"` and `"sigma"`
  for a normal distribution).
* **Link Functions**: It must specify the link functions associated with each parameter.
* **Density Function**: A `d()` function must be provided to evaluate the (log-)density of the
  distribution.

Optionally, a family object can include functions to calculate the log-likelihood,
random number generation, cumulative distribution function (CDF), and quantile function.

Here's an example of a minimal family object for the normal distribution.

```{r}
Normal <- function(...) {
  fam <- list(
    "family" = "Normal",
    "names" = c("mu", "sigma"),
    "links" = c("mu" = "identity", "sigma" = "log"),
    "d" = function(y, par, log = FALSE, ...) {
      dnorm(y, par$mu, par$sigma, log = log)
    },
    "type" = "Continuous"
  )
  class(fam) <- "gamlss2.family"
  return(fam)
}
```

In this example, we define a normal distribution with two parameters: `"mu"` (mean) and `"sigma"`
(standard deviation). The link function for `"mu"` is the identity, and for `"sigma"`,
it is the log function. The density function uses the standard `dnorm()` function from
to calculate the normal density.

## Density Function

The density function must accept the following arguments:

```{r, eval=FALSE}
d(y, par, log = FALSE, ...)
```

* `y`: The response variable.
* `par`: A named list of parameters (e.g., `"mu"`, `"sigma"` for the normal distribution).
* `log`: A logical value indicating whether to return the log-density.

## Optional Derivatives

Family objects can optionally include functions to compute the first and second derivatives of
the log-likelihood with respect to the predictors (or its expectations). These derivatives are used for
optimization during model fitting.

The derivative functions follow the form:

```{r, eval=FALSE}
function(y, par, ...)
```

The derivate functions of first order must be provided as a named list, one list element for
each parameter of the distribution, and is named `"score"`. The second order derivative list
is named `"hess"`. Note that these functions must return the derivative **w.r.t. predictor**
and the `"hess"` functions must return the **negative** (expected) second derivatives

An example of setting up first and second order derivatives for the normal is
provided in the following code:

```{r}
Normal <- function(...) {
  fam <- list(
    "family" = "Normal",
    "names" = c("mu", "sigma"),
    "links" = c("mu" = "identity", "sigma" = "log"),
    "d" = function(y, par, log = FALSE, ...) {
      dnorm(y, par$mu, par$sigma, log = log)
    },
    "type" = "Continuous",
    "score" = list(
      "mu" = function(y, par, ...) {
        (y - par$mu) / (par$sigma^2)
      },
      "sigma" = function(y, par, ...) {
        -1 + (y - par$mu)^2 / (par$sigma^2)
      }
    ),
    "hess" = list(
      "mu" = function(y, par, ...) {
        1 / (par$sigma^2)
      },
      "sigma" = function(y, par, ...) {
        rep(2, length(y))
      }
    )
  )
  class(fam) <- "gamlss2.family"
  return(fam)
}
```

If no derivatives are provided, numerical approximations will be used by the package.

## Additional Functions

Family objects can also include other functions such as:

* Cumulative distribution function (`p()`).
* Quantile function (`q()`).
* Random number generation (`r()`).

These functions should adhere to the same structure as the density function, taking the response
(`y`), parameters (`par`), and other relevant arguments.
Note that the CDF `p()` function is needed it for computing the quantile residuals. 

## Flexible Links

The example above used static link functions to define the family object. However, `gamlss2`
also allows users to define families with flexible link functions.
To support this, the helper function `make.link2()` is used. The only nontrivial part is
adapting the `score` and `hess` functions to work on the linear predictor scale.
This is not done automatically in `gamlss2` for performance reasons - users may even
write these functions in C for speed. Below is a minimal example of implementing the
`Normal` family with flexible link functions:

```{r}
Normal <- function(mu.link = "identity", sigma.link = "log", ...) {
  mu.link <- make.link2(mu.link)
  sigma.link <- make.link2(sigma.link)

  fam <- list(
    "family" = "Normal",
    "names" = c("mu", "sigma"),
    "links" = list("mu" = mu.link, "sigma" = sigma.link),
    "d" = function(y, par, log = FALSE, ...) {
      dnorm(y, mean = par$mu, sd = par$sigma, log = log)
    },
    "type" = "Continuous"
  )

  class(fam) <- "gamlss2.family"
  return(fam)
}
```

Note that in this version, the `"links"` element is a list to support passing full link
function objects with derivatives. Also, the `score` and `hess` elements are omitted here
and are approximated numerically in this case.

The following is a small example using the new `Normal` family with different link functions.

```{r}
set.seed(123)

n <- 200
age <- sort(runif(n, 0, 20))

## true nonlinear relationship (e.g., growth curve)
mu_true <- 100 * (1 - exp(-0.2 * age)) ## saturating growth
sigma_true <- 2 + 0.3 * age            ## increasing variance

## simulate data
y <- rnorm(n, mean = mu_true, sd = sigma_true)
d <- data.frame(age = age, y = y)
```

We now compare two models, one using an identity link (default) and one using a
flexible `softplus` link.

```{r}
m1 <- gamlss2(y ~ s(age) | ., data = d, family = Normal(mu.link = "identity"))
m2 <- gamlss2(y ~ s(age) | ., data = d, family = Normal(mu.link = softplus))
```

The fitted means are visualized with

```{r}
plot(age, y, pch = 16, col = rgb(0, 0, 0, 0.2))
lines(age, fitted(m1)$mu, col = 2, lwd = 5)
lines(age, fitted(m2)$mu, col = 4, lwd = 2)
legend("topleft",
  legend = c("Identity", "Softplus"),
  col = c(2, 4), lwd = 2, bty = "n")
```

Both models yield nearly identical fits in this case, however, in practice, flexible links
can help stabilize estimation or improve fit in more complex scenarios
(e.g., bounded responses, nonlinear link-scale effects).

## Summary

Family objects in the `gamlss2` package are a fundamental component for defining flexible,
distribution-based regression models, and beyond. By encapsulating the necessary elements,
such as parameters, link functions, and density functions, they provide a powerful framework
for customizing models to fit specific data. The flexibility to define custom families,
as demonstrated with the `Normal()` distribution, enables users to extend the package
beyond its default families, making it adaptable to a wide range of modeling scenarios.
Furthermore, the ability to define both static and dynamic link functions enhances the
versatility of `gamlss2` for distributional regression, empowering users to tailor
models to their unique data and research needs.

